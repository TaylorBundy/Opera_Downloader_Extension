chrome.action.onClicked.addListener(async (tab) => {
    if (!tab.url.includes("x.com/")) {
      alert("No estás en un tweet de X.");
      return;
    }
  
    // Guardamos la URL del tweet en sessionStorage del navegador
    const tweetUrl = tab.url;
  
    // Abrimos xdownloader
    chrome.tabs.create({ url: "https://xdownloader.com/es" }, (newTab) => {
      // Esperamos a que cargue y le pasamos la URL del tweet
      chrome.scripting.executeScript({
        target: { tabId: newTab.id },
        func: (url) => {
          sessionStorage.setItem("tweetUrl", url);
        },
        args: [tweetUrl]
      });
    });
  });
  

// chrome.action.onClicked.addListener(async (tab) => {
//     if (!tab.url.includes("x.com/")) {
//       alert("No estás en un tweet de X.");
//       return;
//     }
  
//     const tweetUrl = tab.url;
  
//     // Abrimos xdownloader en background para obtener el enlace
//     const tempTab = await chrome.tabs.create({ url: "https://xdownloader.com/es", active: false });
  
//     chrome.scripting.executeScript({
//       target: { tabId: tempTab.id },
//       func: async (url) => {
//         const input = document.querySelector("#postLink");
//         input.value = url;
  
//         const btnCargar = [...document.querySelectorAll("button")]
//           .find(b => b.textContent.includes("  Cargar videos"));
//         btnCargar.click();
  
//         function esperarDescarga() {
//           return new Promise(resolve => {
//             const observer = new MutationObserver(() => {
//               const btnDescargar = [...document.querySelectorAll("button")]
//                 .find(b => b.textContent.includes(" Descargar\n        ") && b.textContent.includes("MP4"));
//               if (btnDescargar) {
//                 observer.disconnect();
//                 resolve(btnDescargar);
//               }
//             });
//             observer.observe(document.body, { childList: true, subtree: true });
//           });
//         }
  
//         const btnDescargar = await esperarDescarga();
//         const enlace = btnDescargar.closest("a")?.href || btnDescargar.dataset.download;
//         enlace;
//       },
//       args: [tweetUrl]
//     }, (result) => {
//       const downloadUrl = result[0].result;
//       if (downloadUrl) chrome.tabs.update(tempTab.id, { url: downloadUrl });
//     });
//   });
  